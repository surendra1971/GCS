steps:
  # Step 1: Copy both init.json files
  - name: 'gcr.io/cloud-builders/gsutil'
    args: ['cp', 'gs://bucket-demo-12/init.json', 'init_prod.json']

  - name: 'gcr.io/cloud-builders/gsutil'
    args: ['cp', 'gs://bucket-demo-13/init.json', 'init_stage.json']

  # Step 2: Merge using jq (preserve prod flags if already exist)
  - name: 'gcr.io/cloud-builders/bash'
    entrypoint: 'bash'
    args:
      - -c
      - |
        apt-get update && apt-get install -y jq
        jq -s '.[1] * .[0]' init_prod.json init_stage.json > init_merged.json

  # Optional: Backup original prod init.json
  - name: 'gcr.io/cloud-builders/gsutil'
    args:
      - cp
      - init_prod.json
      - gs://bucket-demo-12/init-backup.json

  # Step 3: Upload merged file to production bucket
  - name: 'gcr.io/cloud-builders/gsutil'
    args: ['cp', 'init_merged.json', 'gs://bucket-demo-12/init.json']
